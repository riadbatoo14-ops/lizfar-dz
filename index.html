<script type="module">
  import { auth } from "./firebase-config.js";
  import { onAuthStateChanged, signOut } 
    from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

  const authBtns = document.getElementById("authBtns");

  // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const userBox = document.createElement("div");
  userBox.className = "hidden flex items-center gap-3 relative transition-all duration-300";
  userBox.innerHTML = `
    <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <img id="userPhoto" class="w-10 h-10 rounded-full border-2 border-yellow-400 object-cover transition hover:scale-105">

    <!-- Ø§Ù„Ø§Ø³Ù… -->
    <span id="userName" class="font-semibold text-yellow-400"></span>

    <!-- Ø²Ø± Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ùƒ -->
    <button id="addProductBtn"
      class="hidden ml-6 px-3 py-1 bg-yellow-400 text-black rounded-full font-semibold hover:bg-yellow-300 transition">
      + ğŸ“¦ Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ùƒ
    </button>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© -->
    <div id="dropdownMenu"
      class="hidden absolute top-12 right-0 bg-gray-800 border border-white/10 rounded-lg shadow-lg w-40 py-2 text-sm">
      <button id="profileBtn"
        class="block w-full text-right px-4 py-2 hover:bg-white/10">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
      <button id="logoutBtn"
        class="block w-full text-right px-4 py-2 hover:bg-white/10 text-red-400">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  `;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¯Ø§Ø®Ù„ Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©
  authBtns.parentElement.appendChild(userBox);

  const addProductBtn = document.getElementById("addProductBtn");
  const loadingIndicator = document.createElement("div");
  loadingIndicator.className = "text-yellow-400 text-sm animate-pulse";
  loadingIndicator.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  authBtns.parentElement.appendChild(loadingIndicator);

  // ğŸ”¥ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, (user) => {
    loadingIndicator.classList.add("hidden");

    if (user) {
      // âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
      authBtns.classList.add("hidden");
      userBox.classList.remove("hidden");
      addProductBtn.classList.remove("hidden");

      const nameEl = document.getElementById("userName");
      const photoEl = document.getElementById("userPhoto");
      nameEl.textContent = user.displayName || "Ù…Ø³ØªØ®Ø¯Ù…";
      photoEl.src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

      // ğŸ”½ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const dropdown = document.getElementById("dropdownMenu");
      photoEl.addEventListener("click", (e) => {
        e.stopPropagation();
        dropdown.classList.toggle("hidden");
      });

      // ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "login.html"; // âœ… Ø¨Ø¯Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      });

      // ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
      document.getElementById("profileBtn").addEventListener("click", () => {
        window.location.href = "profile.html";
      });

      // ğŸ“¦ Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ùƒ
      addProductBtn.addEventListener("click", () => {
        window.location.href = "add-product.html";
      });

    } else {
      // âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
      authBtns.classList.remove("hidden");
      userBox.classList.add("hidden");
      addProductBtn.classList.add("hidden");
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener("click", (e) => {
    const dropdown = document.getElementById("dropdownMenu");
    if (dropdown && !dropdown.contains(e.target) && !e.target.closest("#userPhoto")) {
      dropdown.classList.add("hidden");
    }
  });
</script>
