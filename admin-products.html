<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة الإدارة | مراجعة المنتجات</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    body {
      font-family: "Cairo", sans-serif;
      background-color: #0b1220;
      color: white;
    }
    .status-new {
      color: #22c55e;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 6px;
    }
    .status-used {
      color: #ef4444;
      font-weight: 600;
      font-size: 0.9rem;
      margin-right: 6px;
    }
    .loader {
      border: 4px solid rgba(255,255,255,0.2);
      border-top: 4px solid #facc15;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="min-h-screen p-6">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold">📦 مراجعة المنتجات الجديدة</h1>
    <button id="refreshBtn" class="bg-yellow-400 hover:bg-yellow-300 text-black font-semibold px-4 py-2 rounded-lg">🔄 تحديث القائمة</button>
  </div>

  <div id="productList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>

  <!-- ✅ إشعار أنيق -->
  <div id="toast" class="fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hidden"></div>

  <footer class="mt-10 text-center text-xs text-gray-400">
    © 2025 Lizfar DZ — لوحة الإدارة
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import { collection, getDocs, deleteDoc, doc, addDoc } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const productList = document.getElementById("productList");
    const refreshBtn = document.getElementById("refreshBtn");
    const toast = document.getElementById("toast");

    function showToast(message, color = "green") {
      toast.textContent = message;
      toast.className = \`fixed bottom-6 right-6 bg-\${color}-600 text-white px-4 py-2 rounded-lg shadow-lg\`;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2500);
    }

    async function loadPendingProducts() {
      productList.innerHTML = "<div class='loader'></div><p class='text-center text-gray-400'>جاري تحميل المنتجات...</p>";

      const snapshot = await getDocs(collection(db, "pending_products"));
      productList.innerHTML = "";

      if (snapshot.empty) {
        productList.innerHTML = "<p class='text-center text-gray-400'>لا توجد منتجات بانتظار المراجعة.</p>";
        return;
      }

      snapshot.forEach((docSnap) => {
        const p = docSnap.data();
        const id = docSnap.id;

        const statusText =
          p.condition === "new"
            ? `<span class='status-new'>(جديد)</span>`
            : `<span class='status-used'>(مستعمل - ${p.usageDuration || "غير محدد"})</span>`;

        const productCard = document.createElement("div");
        productCard.className = "bg-white/10 p-5 rounded-2xl shadow-md border border-white/10";

        productCard.innerHTML = `
          <h2 class="text-lg font-semibold mb-2 flex items-center">
            ${p.name || "منتج بدون اسم"} ${statusText}
          </h2>

          <div class="grid grid-cols-3 gap-2 mb-3">
            ${p.images?.map(img => `<img src="${img}" class="rounded-lg object-cover h-24 w-full">`).join("") || ""}
          </div>

          <p class="text-sm text-gray-300 mb-2">${p.desc || "لا يوجد وصف"}</p>
          <p class="text-yellow-400 font-bold mb-1">${p.price || "غير محدد"} دج</p>
          <p class="text-sm text-gray-400 mb-1">📍 الولاية: ${p.state || "غير محددة"}</p>
          <p>📞 <a href="https://wa.me/${p.whatsapp}" target="_blank" class="text-green-400 underline">${p.whatsapp}</a></p>

          <div class="flex justify-between mt-4">
            <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded" data-action="approve" data-id="${id}">قبول ✅</button>
            <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded" data-action="reject" data-id="${id}">رفض ❌</button>
          </div>
        `;

        productList.appendChild(productCard);
      });

      productList.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          const action = e.target.dataset.action;
          const productRef = doc(db, "pending_products", id);
          const productData = snapshot.docs.find(d => d.id === id).data();

          if (action === "approve") {
            await addDoc(collection(db, "approved_products"), {
              ...productData,
              approvedAt: new Date(),
            });
            await deleteDoc(productRef);
            showToast("✅ تم قبول المنتج ونقله إلى المتجر!");
          } else if (action === "reject") {
            await deleteDoc(productRef);
            showToast("🚫 تم رفض المنتج!", "red");
          }

          loadPendingProducts();
        });
      });
    }

    refreshBtn.addEventListener("click", loadPendingProducts);
    loadPendingProducts();
  </script>
  <script type="module" src="js/firebase-config.js"></script>
<script type="module" src="js/auth-guard.js"></script>
</body>
</html>

